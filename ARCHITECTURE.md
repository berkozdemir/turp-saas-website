# Architecture & Components Guide

This document provides a comprehensive overview of the **Turp SaaS Website** architecture, including its multi-tenant structure, key modules, folder organization, and coding standards. It serves as a central reference for developers and AI assistants working on the project.

## 1. General Architecture

### Multi-Tenancy
The application is built on a **multi-tenant architecture** that serves different content and branding based on the incoming domain (Host).
-   **Tenant Resolution:** The Frontend (`App.tsx`) and Backend (`tenant.service.php`) resolve the tenant context from the hostname (e.g., `nipt.tr` -> `nipt`, `iwrs.com.tr` -> `iwrs`).
-   **Tenant Identification:**
    -   **Tenant Code (Slug):** Used in application logic and API requests (e.g., `'nipt'`, `'turp'`).
    -   **Tenant ID (PK):** Used internally in the database as a foreign key (`INT`).
    -   **Standardization:** The system is standardized to strictly use integer IDs for internal relationships, with helper functions to map between Slugs and IDs.

### Core Stack
-   **Frontend:** React (Vite), TypeScript, Tailwind CSS.
-   **Backend:** Modular PHP API (Native), MySQL.
-   **Key Features:**
    -   **Media Manager:** Multi-tenant file management with auto-optimization.
    -   **AI Integrations:** Chatbots (OpenAI/Anthropic) for support and content generation.
    -   **Dynamic Routing:** Domain-based routing for NIPT, IWRS, and Corporate sites.

---

## 2. Folder Structure

### `src/` (Frontend Source)
-   **`src/pages/`**: Public-facing pages for the main corporate site (`turp.health`) and admin panel routes (`/admin`).
-   **`src/nipt/`**: Dedicated module for the `nipt.tr` tenant, containing its specific pages (`pages/`), components (`components/`), and logic.
-   **`src/iwrs/`**: Dedicated module for the `iwrs.com.tr` tenant.
-   **`src/components/`**: Shared UI components used across all tenants (e.g., `PodcastPlayer`, `Chatbot`).
-   **`src/context/`**: Global state providers (e.g., `TenantContext`, `PodcastPlayerContext`).
-   **`src/hooks/`**: Custom React hooks (e.g., `useTenantSettings`, `useEndUserAuth`).

### `api/` (Backend API)
The API follows a **Front Controller** pattern (`index.php`) that dispatches requests to modular controllers.
-   **`api/modules/`**: Contains domain-specific logic. Each module (e.g., `podcast`, `legal`, `nipt`) has its own:
    -   `*.controller.php`: Handles request inputs and responses.
    -   `*.service.php`: Contains business logic and database interactions.
-   **`api/core/`**: Core system services.
    -   `auth/`: JWT authentication and middleware.
    -   `tenant/`: Tenant resolution and configuration.
    -   `errors/`: Global error handling.
-   **`api/routes/`**: Route definitions mapping `action` parameters to controller functions (`public.routes.php`, `admin.routes.php`).
-   **`api/scripts/`**: Maintenance, migration, and debug scripts.
    -   `api/scripts/debug/`: Temporary debug and health check tools.
-   **`api/archive/`**: Deprecated legacy code and backups.

### `scripts/` (Project Scripts)
-   Contains shell or Node.js scripts for build processes.

### `dist/` (Build Output)
-   Contains the compiled frontend assets (`index.html`, JS, CSS) generated by `npm run build`. This is the directory served by the web server in production.

---

## 3. Key Modules & Components

### Podcast Hub & Detail (NIPT)
-   **Routes:** `/podcast`, `/podcast/:slug`
-   **Components:**
    -   `PodcastHub`: Lists episodes with filtering.
    -   `PodcastDetail`: Shows episode info, audio player, and transcript.
    -   `PodcastAIDisclaimer`: Displays AI generation warning under players.
    -   `StickyAudioPlayer`: Persistent global player.
-   **Features:** AI-generated content disclaimer, "Preview" mode for gated content.

### Chatbots / AI Assistants
-   **NIPT Podcast Chatbot:** RAG-based bot allowing users to ask questions about podcast content. Requires user login.
-   **IWRS AI Assistant:** Help bot for the IWRS platform, integrated into the dashboard.

### Media Manager
-   **Functionality:** Centralized file upload and management for the Admin Panel.
-   **Optimization:** Automatic resizing and compression (WebP) using `ImageOptimizerService`.
-   **Multi-tenant:** Isolates files per tenant ID.

### Legal Documents
-   **Management:** Admin panel interface to edit Terms, KVKK, Privacy Policy.
-   **Visibility:** Dynamic fetching based on Tenant ID.
-   **Content:** Supports multilingual content (TR, EN, etc.).

---

## 4. Tenant Logic & Context

1.  **Host Resolution:**
    -   The browser sends `Host` header.
    -   `TenantService` maps `nipt.tr` -> Tenant ID `3`.
    -   Frontend sets `X-Tenant-Id` header for API requests.

2.  **Database Isolation:**
    -   Tables like `podcasts`, `legal_documents`, `media_files` have a `tenant_id` column.
    -   All queries MUST filter by `tenant_id`.

---

## 5. Coding & Commenting Standards

To maintain clarity in a complex multi-tenant codebase, strictly follow this commenting standard for all major files.

### Standard Header Block
Place this at the very top of `Page`, `Controller`, or `Service` files.

```php
/**
 * [Type]: [Name]
 * [Context]: [Route / Endpoint / Tenant]
 * Description:
 *   - [Bullet 1: Main purpose]
 *   - [Bullet 2: Key feature]
 * Related:
 *   - API: [Related endpoints]
 *   - Components: [Related key components]
 */
```

### Examples

**Frontend Page (`src/nipt/pages/VerifiIntro.tsx`):**
```tsx
/**
 * Page: Verifi Intro (NIPT)
 * Route: /t/verifi
 * Tenant: NIPT
 * Description:
 *   - Landing page for Verifi product.
 *   - Includes embedded Podcast Player with AI Disclaimer.
 * Related:
 *   - Components: PodcastAIDisclaimer, NIPTHeader
 */
```

**Backend Controller (`api/modules/podcast/podcast.controller.php`):**
```php
/**
 * Module: Podcast Controller
 * Endpoint: ?action=get_podcasts, ?action=get_podcast_detail
 * Description:
 *   - Handles fetching podcast episodes and details.
 *   - Filters content by tenant_id.
 * Related:
 *   - Service: podcast.service.php
 */
```

---

## 6. Additional Modules

### 6.1. IWRS (Randomizasyon)
- **Folder:** `src/iwrs/`
- **Entry:** `IWRSApp.tsx`
- **Key Features:**
  - Independent `RandomizationBot` for clinical trial support.
  - Dedicated authentication flow (`src/hooks/useEndUserAuth`).

### 6.2. Chatbot & RAG
- **Core Service:** `api/modules/chatbot/chatbot.service.php`
- **RAG Engine:** `api/modules/chatbot/rag.service.php` (DeepSeek integration)
- **Frontend:**
  - Shared Hook: `src/hooks/useChatbot.tsx`
  - Components: `RandomizationBot.tsx` (IWRS), `ChatWidget.tsx` (NIPT)

---

## 7. Deployment & Infrastructure

### 7.1. Infrastructure Stack
- **Server Provider:** Hetzner Cloud (VPS)
- **Control Panel:** Plesk Obsidian
- **OS:** Ubuntu / AlmaLinux (Plesk Managed)
- **Web Server:** Nginx (Proxy) + Apache (Backend)
- **Database:** MariaDB (MySQL Compatible)
- **Runtime:** PHP 8.2 (Backend), Node.js (Build tools)

### 7.2. CI/CD Flow (GitHub -> Plesk)
1.  **Development:**
    - Code changes pushed to `main` branch on GitHub.
2.  **Webhook Trigger:**
    - GitHub sends a webhook payload to Plesk Server.
3.  **Plesk Pull:**
    - Plesk's Git extension automatically pulls the latest changes to `/var/www/vhosts/turp.health/httpdocs`.
4.  **Post-Deployment Actions:**
    - Plesk executes `composer install` (if PHP deps change).
    - Frontend build is typically committed `dist/` or built on server via `npm run build` (depending on configuration).
    - Database migrations are run manually or via script if needed.

### 7.3. Key Locations on Server
- **Root:** `/var/www/vhosts/turp.health/httpdocs`
- **Logs:** `/var/www/vhosts/turp.health/logs` (error_log, access_log)
- **Env:** `.env` file located in project root (not in git).

---

## 8. Data Model & Schema

Since the project uses a standard SQL database (MariaDB/MySQL), here are the core entities:

### 8.1. Core Tables
- **`tenants`**: Stores tenant config (`id`, `code`, `name`, `domain`).
- **`users`**: Admin panel users with role-based access.
- **`endusers`**: Application-specific users (e.g., NIPT patients, IWRS doctors).

### 8.2. Content Tables
- **`podcasts`**: Episodes linked to tenants (`tenant_id`).
- **`podcast_categories`**: Categorization for episodes.
- **`media_files`**: Centralized media assets.
- **`legal_documents`**: KVKK, Terms, Privacy Policy texts.

### 8.3. Module Tables
- **`iwrs_randomizations`**: Clinical trial randomization records.
- **`nipt_bookings`**: Patient test bookings.
- **`chatbot_logs`**: Interaction history for AI bots.

---

## 9. Security & Authentication

### 9.1. Authentication Strategies
- **Admin Panel:** Uses **Session-based auth**. Admins log in via `/admin` and session persists.
- **End Users (NIPT/IWRS):** Uses **JWT (JSON Web Tokens)**.
  - Login returns a token stored in `localStorage` or `HelpScout` cookies.
  - Requests validation via `Authorization: Bearer <token>` header.

### 9.2. Tenant Isolation
- **Strict Filtering:** Every `SELECT`, `UPDATE`, `DELETE` operation on shared tables MUST include `WHERE tenant_id = ?`.
- **Middleware:** Backend middleware validates that the requested resource belongs to the active tenant in the header.

### 9.3. Environment Security
- Sensitive keys (DB credentials, API Keys for Brevo/DeepSeek) are stored in `.env` (production) or `env.php` (legacy/local).
- **Never** commit these keys to version control.

---

## 10. Third-Party Integrations

### 10.1. Brevo (Email Service)
- **Use Case:** Transactional emails (Password Reset, Contact Form notifications).
- **Core File:** `api/modules/nipt/email_service.php`
- **Config:** `BREVO_API_KEY` (env).
- **Endpoint:** `https://api.brevo.com/v3/smtp/email` via cURL.

### 10.2. DeepSeek (AI/LLM)
- **Use Case:** Chatbot logic and content generation (RAG support).
- **Core File:** `api/modules/chatbot/deepseek.service.php`
- **Config:** `DEEPSEEK_API_KEY` (env).
- **Model:** `deepseek-chat`.

### 10.3. Google Services
- **Google Analytics 4:**
    -   **File:** `src/lib/analytics.ts`
    -   **Config:** `VITE_GA_MEASUREMENT_ID`.
    -   **Events:** `page_view`, `button_click`, `form_submit`.
- **Google Maps:** Embedded in Contact pages via iframe.

### 10.4. HelpScout (Support)
- **Use Case:** Customer support widget and cookie management.
- **Integration:** Script tag injection in `index.html` (managed via dashboard).
