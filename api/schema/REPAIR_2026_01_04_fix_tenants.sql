-- REPAIR SCRIPT: Fix Partial Migration
-- Generated by Antigravity on 2026-01-05
-- PURPOSE: Force clean remaining string tenant_ids and apply INT conversion

SET FOREIGN_KEY_CHECKS = 0;

-- 1. Force Update Remaining Strings in SITE_SETTINGS
UPDATE site_settings SET tenant_id = '1' WHERE tenant_id = 'turp';
UPDATE site_settings SET tenant_id = '2' WHERE tenant_id = 'iwrs';
UPDATE site_settings SET tenant_id = '3' WHERE tenant_id = 'nipt';
UPDATE site_settings SET tenant_id = '4' WHERE tenant_id = 'wes' OR tenant_id = 'westesti';
UPDATE site_settings SET tenant_id = '5' WHERE tenant_id = 'trombo' OR tenant_id = 'trombofili';

-- 2. Force Update Remaining Strings in FAQS
UPDATE faqs SET tenant_id = '1' WHERE tenant_id = 'turp';
UPDATE faqs SET tenant_id = '2' WHERE tenant_id = 'iwrs';
UPDATE faqs SET tenant_id = '3' WHERE tenant_id = 'nipt';
UPDATE faqs SET tenant_id = '4' WHERE tenant_id = 'wes' OR tenant_id = 'westesti';
UPDATE faqs SET tenant_id = '5' WHERE tenant_id = 'trombo' OR tenant_id = 'trombofili';

-- 3. Force Update Remaining Strings in LEGAL_DOCUMENTS
UPDATE legal_documents SET tenant_id = '1' WHERE tenant_id = 'turp';
UPDATE legal_documents SET tenant_id = '2' WHERE tenant_id = 'iwrs';
UPDATE legal_documents SET tenant_id = '3' WHERE tenant_id = 'nipt';
UPDATE legal_documents SET tenant_id = '4' WHERE tenant_id = 'wes' OR tenant_id = 'westesti';
UPDATE legal_documents SET tenant_id = '5' WHERE tenant_id = 'trombo' OR tenant_id = 'trombofili';

-- 4. Retry ALTER TABLE (Conversion to INT)
ALTER TABLE faqs MODIFY tenant_id INT NOT NULL DEFAULT 1;
ALTER TABLE legal_documents MODIFY tenant_id INT NOT NULL DEFAULT 1;
ALTER TABLE site_settings MODIFY tenant_id INT NOT NULL DEFAULT 1;

-- 5. Retry Adding Foreign Keys
-- Using IF NOT EXISTS logic via duplicates is hard in pure SQL, so we assume they don't exist or use unique names
-- Attempting to add with _v3 suffix to be absolutely sure
ALTER TABLE faqs ADD CONSTRAINT fk_faqs_tenant_id_v3 FOREIGN KEY (tenant_id) REFERENCES tenants(id);
ALTER TABLE legal_documents ADD CONSTRAINT fk_legal_documents_tenant_id_v3 FOREIGN KEY (tenant_id) REFERENCES tenants(id);
ALTER TABLE site_settings ADD CONSTRAINT fk_site_settings_tenant_id_v3 FOREIGN KEY (tenant_id) REFERENCES tenants(id);

SET FOREIGN_KEY_CHECKS = 1;
