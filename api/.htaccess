# Enable Authorization header passthrough
# Required for PHP CGI/FastCGI environments

# Pass Authorization header to PHP
# <IfModule mod_rewrite.c>
#     RewriteEngine On
#     
#     # Pass Authorization header
#     RewriteCond %{HTTP:Authorization} .+
#     RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
# </IfModule>

# Alternative method for mod_setenvif
# <IfModule mod_setenvif.c>
#     SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
# </IfModule>

# PHP CGI specific fix
# <IfModule mod_cgi.c>
#     RewriteCond %{HTTP:Authorization} ^(.*)
#     RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]
# </IfModule>

# ========================================
# SECURITY: Block access to sensitive files
# ========================================

# Block access to env.php (credentials file)
<Files "env.php">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</Files>

# Block access to all helper files (only index.php should be accessed)
<FilesMatch "^(auth_helper|email_helper|forgot_password_helper|db_connection)\.php$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block access to SQL files
<FilesMatch "\.(sql|log|bak|backup|old)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block access to version.txt and other sensitive text files
<Files "version.txt">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</Files>

# ========================================
# UPLOADS: Allow access to uploaded media files
# ========================================
<IfModule mod_rewrite.c>
    # Allow direct access to files in uploads directory
    RewriteCond %{REQUEST_URI} ^/api/uploads/
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^uploads/(.*)$ uploads/$1 [L]
</IfModule>

# Force correct MIME types for uploaded images
<IfModule mod_mime.c>
    AddType image/jpeg .jpg .jpeg
    AddType image/png .png
    AddType image/gif .gif
    AddType image/webp .webp
    AddType image/svg+xml .svg
</IfModule>

# Enable CORS for images in uploads
<IfModule mod_headers.c>
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>
